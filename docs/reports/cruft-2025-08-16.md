# Cruft Report — 2025-08-16

This preliminary report inventories duplicate/near-duplicate utilities and NIP-related surfaces to consolidate in Phase 1. It is intentionally conservative and grounded in current files.

## Findings

- **Duplicate utilities (utils.ts)**
  - `packages/extension/src/utils.ts`
  - `packages/shared-types/src/utils.ts`
  - `packages/ui/src/lib/utils.ts`
  - `packages/ui/src/lib/utils/binaryUtils.ts`

- **NIP-related declarations spread across packages**
  - `packages/shared-types/src/nip34.ts` (canonical types)
  - `packages/shared-types/src/nip22.ts` (canonical types)
  - `packages/core/src/lib/nip34.ts` (re-exports + helper)
  - Multiple UI guides/readmes reference NIPs (no code action required)

- **Path alias mismatch (fixed in Phase 0)**
  - `tsconfig.base.json` previously mapped `@nostr-git/types` → `packages/shared-types`; fixed to `@nostr-git/shared-types` → `packages/shared-types/src`.

## Updates (2025-08-16)

- **binaryUtils centralized**
  - Moved `packages/ui/src/lib/utils/binaryUtils.ts` → `packages/core/src/lib/utils/binaryUtils.ts`.
  - Exported via `packages/core/src/index.ts` as part of `@nostr-git/core` public API.
  - UI now provides a re-export shim at `packages/ui/src/lib/utils/binaryUtils.ts` to avoid breaking imports.
  - Included helpers: `createDataUrl`, `binaryStringToBytes`, `toBase64`, `createBlob`, `isBinaryContent`.

- **Other util files reviewed**
  - `packages/ui/src/lib/utils.ts` contains Svelte/Tailwind UI helpers (package-specific) — kept in UI.
  - `packages/extension/src/utils.ts` contains DOM/UI helpers for the extension — kept in extension.

## Proposed Consolidations (Phase 1)

- **Centralize cross-cutting types and helpers**
  - Move any shared value/type utilities used by more than one package into `@nostr-git/shared-types` with clear doc comments.
  - Replace local copies:
    - `extension/src/utils.ts` → import from `@nostr-git/shared-types` or `@nostr-git/core` depending on runtime.
    - `ui/src/lib/utils.ts` → split: pure type/shape helpers to `shared-types`; UI-only helpers stay in UI.
    - `ui/src/lib/utils/binaryUtils.ts` → if browser-git related, move to `@nostr-git/core` (public util) or wrap behind adapter.

- **NIP-34/-22/-51 contracts**
  - Keep all event/tag/kind types in `@nostr-git/shared-types`.
  - `@nostr-git/core` should only provide construction/parsing functions that delegate to `shared-types` to avoid drift (already partially true in `core/src/lib/nip34.ts`).

- **Normalize file naming where touched**
  - Prefer `kebab-case` filenames and `index.ts` barrels in changed areas; avoid repo-wide churn in Phase 1.

## Deletions (Candidates)

- After consolidation:
  - Remove duplicated helper functions from `extension/src/utils.ts` and `ui/src/lib/utils.ts` once imports are switched.

## Risks

- Minimal: changes are localized and will include type-safe replacements. Ensure UI continues to tree-shake by keeping `sideEffects: false` where safe.

## Next Steps

1. Extract shared utilities into `@nostr-git/shared-types` (types-only) or `@nostr-git/core` (runtime helpers) with doc comments.
2. Update consumers to import from canonical modules.
3. Add compile-time tests for primary types in `shared-types`.
4. Run `pnpm -r build` and adjust exports maps if any public entry changes.
